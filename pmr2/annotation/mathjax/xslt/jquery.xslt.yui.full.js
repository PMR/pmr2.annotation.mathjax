/*
 * XSLT Templater - jQuery plugin for cached transforming XML with XSLT
 * <http://www.xslt-templater.com>
 * 
 * Version: 0.0.5
 * 
 * Copyright (c) 2010 Tsarev Oleg (<mailto:tsarev.oi@mail.ru>)
 * <http://live-scopes.blogspot.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
 * NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
 * USE OR OTHER DEALINGS IN THE SOFTWARE.
 * 
 */
(function(h){h.fn.xslt=function(){return this};var e;if(window.DOMParser!=undefined&&window.XSLTProcessor!=undefined&&window.XMLHttpRequest!=undefined){var d=new XSLTProcessor();if(h.isFunction(d.transformDocument)){support=window.XMLSerializer!=undefined}else{support=true}if(support){e=true}}else{if(document.recalc){e=false}}if(e!=undefined){function p(O,I){var R=null;var J=null;var N=false;var L=false;var P=null;var Q=false;var K=(O!==null)?O:true;this.onUnlock=(I&&I.onUnlock)?(I.onUnlock):(function(S){});function M(S){return(new XMLSerializer()).serializeToString(S)}this.setXmlDoc=function(S){this.xmlDoc=S;if(this.mode){this.xmlString=M(this.xmlDoc)}};this.setXslDoc=function(S){this.xslDoc=S;if(this.mode){this.xslString=M(this.xslDoc)}};this.getXmlDoc=function(){return this.xmlDoc};this.getXmlString=function(){if(K){return this.xmlString}else{if(this.xmlDoc){return this.xmlDoc.xml}else{return false}}};this.getXslDoc=function(){return this.xslDoc};this.getXslString=function(){if(K){return this.xslString}else{if(this.xslDoc){return this.xslDoc.xml}else{return false}}};this.setResultDoc=function(S){this.resultDoc=S};this.getResultDoc=function(){return this.resultDoc};this.lock=function(){this.key=true};this.locked=function(){return this.key};this.unlock=function(){this.key=false;this.onUnlock({xmlDoc:this.xmlDoc,xslDoc:this.xslDoc,resultDoc:this.resultDoc})};this.checkXmlDoc=function(){if(this.xmlDoc){return true}return false};this.checkXslDoc=function(){if(this.xslDoc){return true}return false};this.checkResultDoc=function(){if(this.resultDoc){return true}return false};this.reset=function(){this.xmlDoc=null;this.xslDoc=null;this.resultDoc=null}}h.getXSLTLocalCache=function(I){return new p(e,I)};h.getXSLTTemplaterInfo=function(){return{version:"0.0.5"}};function f(){this.setElement=function(I,J){if(!this[I]){this[I]=J;return true}return false};this.getElement=function(I){if(this[I]){return this[I]}return false}}var A=new f();var D=new f();var x=new f();var n=function(J,I){if(window.console&&window.console.log){if(I){J=J+" Element:"+I.attr("id")}window.console.log(J)}};var u=function(I){if(window.console&&window.console.error){window.console.error(I)}};function F(J){var I=J;this.calculate=(I)?(function(P,M,O,L,S){var N=new XSLTProcessor();var R,Q;if(h.isFunction(N.transformDocument)){R=document.implementation.createDocument("","",null);N.transformDocument(M.responseXML,O.responseXML,R,null);Q=new XMLSerializer().serializeToString(R);if(P){P.html(Q)}}else{N.importStylesheet(O.responseXML);R=N.transformToFragment(M.responseXML,document);if(P){P.empty().append(R)}Q=new XMLSerializer().serializeToString(R)}var K={resultDoc:Q,xmlDoc:M.responseXML,xslDoc:O.responseXML};S(K)}):(function(O,K,P,L,Q){if(c(L.xmlnode)){L.xmlnode.load(K.responseXML)}if(c(L.xslnode)){L.xslnode.load(P.responseXML)}var M=L.xmlnode.transformNode(L.xslnode.XMLDocument);if(O){O.html(M)}var N={resultDoc:M,xmlDoc:L.xmlnode.XMLDocument,xslDoc:L.xslnode.XMLDocument};Q(N)})}var r=new F(e);var E=(e)?(function(I){return I instanceof Object}):(function(I){return typeof I=="object"});var z=(e)?(function(I,K,J){I.responseXML=new DOMParser().parseFromString(K,"text/xml");return I}):(function(I,K,J){if(J.loadXML(K)){I.responceXML=J.XMLDocument}return I});var i=(e)?(function(J,I){}):(function(J,I){h("body").append(J).append(I)});var H=(e)?(function(J,I){}):(function(J,I){document.body.removeChild(J);document.body.removeChild(I)});var v=(e)?(function(){return{xmlnode:null,xslnode:null}}):(function(){return{xmlnode:document.createElement("xml"),xslnode:document.createElement("xml")}});var j=(e)?(function(){return m(0)}):(function(K,L,J){var I=m(4);if(K.load(L)){I.responceXML=K.XMLDocument;I.call=J}return I});var l=(e)?(function(){}):(function(I){if(I.call){I.call()}});var g=function(I){if(I==null){return{xml:false,xsl:true,result:false,ajax:false}}else{if(I===true){return{xml:true,xsl:true,result:true,ajax:true}}}return I};var y=function(I,J){if(I){I.lock();I.reset();I.setResultDoc(J);I.unlock()}};var m=function(I){return{readyState:I,getResponseHeader:function(J){return null}}};var G=function(I,M,L,K){if(M){if(!E(I)){var J=L.getElement(I);if(J){n(I+" - already cached!",K);return J}}}return I};var C=function(K,I,J){if(K){return I}return J};var w=function(I,J){I.responseXML=J;return I};var b=function(I){return I.responseXML};var B=function(I,J){if(I){return false}return J};var o=function(I,J){if(I){if(I>new Date()){return false}else{return true}}return J};var t=function(I,L,K,J){I=h.ajax({dataType:"xml",url:L,cache:false});if(I!=null){I.onreadystatechange=K}else{I=j(J,L,K)}return I};var c=function(I){if(I.XMLDocument==null||I.XMLDocument.xml==""){return true}return false};var s=function(J,L,K,I,M){if(J&&L.readyState==k){I.setElement(K+M,L.responseXML)}};var a=function(N,M,L,O){var K=N.getResponseHeader("Cache-control");var J=N.getResponseHeader("Pragma");var I=N.getResponseHeader("Expires");return{responseXML:L.getElement(M+O),getResponseHeader:function(P){switch(P){case"Cache-control":return K;break;case"Pragma":return J;break;case"Expires":return I;break;case"":return null;break;default:return null}}}};var q=/^\s*</;var k=4;h.fn.xslt=h.xslt=function(M,ab,N,W,ad){var K=new Date().getTime();var ah=(h.isFunction(this))?null:h(this);var aj=false;ad=g(ad);var X=A;var ai=D;var O=x;if(ad&&ad.result){if((!E(M))&&(!E(ab))){var Z=X.getElement(M+"#"+ab);if(Z){n("Transforming result already cached!",ah);if(ah){ah.html(Z)}y(W,Z);ae();if(ah){return this}else{return}}}}var J="";var ac="";var Q="";var aa="";var V="";var T=false;var L=false;var R=m(k);var ag=m(k);var Y=v();i(Y.xmlnode,Y.xslnode);function I(ak,al){if(ak){if(!ak.checkXmlDoc()){ak.setXmlDoc(al.xmlDoc)}if(!ak.checkXslDoc()){ak.setXslDoc(al.xslDoc)}if(!ak.checkResultDoc()){ak.setResultDoc(al.resultDoc)}ak.unlock()}}function P(am,al){if(am&&am.xml){if(J!=""){var ak=al.xmlDoc;X.setElement(J,ak)}}if(am&&am.xsl){if(ac!=""){var ao=al.xslDoc;X.setElement(ac,ao)}}if(am&&am.result){if(Q!=""){var an=al.resultDoc;X.setElement(Q,an)}}}function S(ar,aq,ap,an){if(aq&&aq.ajax){if(ap!=""){function ao(au,av){var at=au.getResponseHeader(av);if(at){return at}return null}function al(au){var at=0;if(au.cache){if(au.cache.indexOf("no-cache")<0&&au.cache.indexOf("no-store")<0){if(au.cache.indexOf("max-age")>0){var av=au.cache.match(/max-age\s*=\s*(\d*)?/i);if(av[1]){date=new Date().getTime()+(av[1]*1000);if(au.expires){au.expires=new Date(Math.min(au.expires.getTime(),date))}else{au.expires=new Date(date)}at=100}else{at=200;au.cache=null}}else{at=100}}else{at=300;au.cache=null}}if(au.expires){if(au.expires>new Date()){at=at+10}else{au.expires=null}}if(at!=0&&at!=200&&at<300){return true}return false}var am={expires:null,cache:null,value:null};am.cache=ao(ar,"Cache-control");if(!am.cache){am.cache=ao(ar,"Pragma")}var ak=ao(ar,"Expires");if(ak){am.expires=new Date(ak)}if(al(am)){am.value=an;n(ap+" added to ajax cache!");ai.setElement(ap,am)}}}}function ae(){if(N){setTimeout(function(){N()},10)}}var U=function(){T=(!T)?(R.readyState==k):true;L=(!L)?(ag.readyState==k):true;s(T,R,K,O,"xml");s(L,ag,K,O,"xsl");if(T&&L&&!aj){R=a(R,K,O,"xml");ag=a(ag,K,O,"xsl");r.calculate(ah,R,ag,Y,function(ak){I(W,ak);P(ad,ak);S(R,ad,aa,ak.xmlDoc);S(ag,ad,V,ak.xslDoc);H(Y.xmlnode,Y.xslnode);ae()});aj=true}};if(W){W.lock();W.reset()}M=G(M,(ad&&ad.xml),X,ah);if(E(M)){R=w(R,M)}else{if(q.test(M)){R=z(R,M,Y.xmlnode);if(W){W.setXmlDoc(b(R))}J=C(ad&&ad.xml,M,"")}else{J=C(ad&&ad.xml,M,"");var Z=false;var af=true;if(ad&&ad.ajax){aa=M;Z=ai.getElement(aa);if(Z){af=B(Z.cache,af);af=o(Z.expires,af);if(!af){n("Ajax resource ("+M+") - already cached!",ah);R.responseXML=Z.value}}}if(!Z||af){R=t(R,M,U,Y.xmlnode)}}}ab=G(ab,(ad&&ad.xsl),X,ah);if(E(ab)){ag=w(ag,ab);U()}else{if(q.test(ab)){ag=z(ag,ab,Y.xslnode);if(W){W.setXslDoc(b(ag))}ac=C(ad&&ad.xsl,ab,"");Q=C(ad&&ad.result,M+"#"+ab,"");U()}else{ac=C(ad&&ad.xsl,ab,"");Q=C(ad&&ad.result,M+"#"+ab,"");var Z=false;var af=true;if(ad&&ad.ajax){V=ab;Z=ai.getElement(V);if(Z){af=B(Z.cache,af);af=o(Z.expires,af);if(!af){n("Ajax resource ("+ab+") - already cached!",ah);ag.responseXML=Z.value;U()}}}if(!Z||af){ag=t(ag,ab,U,Y.xslnode);l(ag)}}}if(ah){return this}else{return}}}})(jQuery);